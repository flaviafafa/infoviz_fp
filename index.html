<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>

    <style>
        body{
            margin: 0px;
            font-family: 'Baloo 2', cursive;
            color: #041F3D;
            display: flex;
            flex-direction: column;
        }

        .container-centered{
            width: 96%;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        h2{
            font-size: 28px;
            font-weight: 700;
        }

        .colored-bg {
            background-color: ffefda
        }

        .session{
            padding-top: 40px;
            padding-bottom: 40px;
        }

        .tooltip {
            z-index: 10 !important;
        }

    </style>


</head>

<body>

    <!--Introduction-->
    <div class="session container-centered">
        <div>
            <h1 style="font-weight:800; font-size: 32px;">
                TITLE TITLE TITLE TITLE TITLE TITLE TITLE TITLE TITLE TITLE TITLE
            </h1>
            <h3>Flavia Jiang, Curtis Xu, Xinyi Zhou</h3>

            <div>Intro paragraph</div>
        </div>
    </div>

    <!--Bite incidents by breed-->
    <div class="session colored-bg">
        <div id="container-breed" class="container-centered">
            <h2>TITLE TITLE TITLE TITLE TITLE TITLE </h2>
            <svg id="svg-breed" height="600" width="1200"></svg>
        </div>
    </div>

    <!--Bite incidents by gender x spay & neuter-->
    <div class="session">
        <div id="container-gender" class="container-centered">
            <h2>TITLE TITLE TITLE TITLE TITLE TITLE </h2>

        </div>
    </div>

    <!--Bite incidents by age-->
    <div class="session colored-bg">
        <div id="container-age" class="colored-bg container-centered">
            <h2>TITLE TITLE TITLE TITLE TITLE TITLE </h2>

        </div>
    </div>

    <!--Bite incidents by time-->
    <div class="session">
        <div id="container-time" class="container-centered">
            <h2>TITLE TITLE TITLE TITLE TITLE TITLE </h2>
            <svg id="svg-time" height="400" width="700"></svg>

        </div>
    </div>

    <!--Bite incidents by neighborhood-->
    <div class="session colored-bg">
        <div id="container-zip" class="colored-bg container-centered">
            <h2>TITLE TITLE TITLE TITLE TITLE TITLE </h2>

        </div>
    </div>



    <script>
        const requestData = async () => {
            // Bite incidents by breed
            const breedData = await d3.csv("breed_df.csv");

            breedData.forEach(d => {
                d.bite_score = 16 - +d.bite_score_ranking;
                d.aggresiveness_score = 16 - +d.aggresiveness_score_ranking;
            });

            const svg_breed = d3.select("#svg-breed");
            const width_breed = +svg_breed.attr("width");
            const height_breed = +svg_breed.attr("height");
            const margin_breed = { top: 50, right: 20, bottom: 50, left: 30 };
            const chartWidth_breed = width_breed - margin_breed.left - margin_breed.right;
            const chartHeight_breed = height_breed - margin_breed.top - margin_breed.bottom;

            const g_breed = svg_breed.append("g")
                .attr("transform", `translate(${margin_breed.left},${margin_breed.top})`);

            g_breed.append("line")
                .attr("x1", 0)
                .attr("y1", chartHeight_breed / 2)
                .attr("x2", chartWidth_breed)
                .attr("y2", chartHeight_breed / 2)
                .attr("stroke", "#041F3D") 
                .attr("stroke-width", 2)
                .lower(); 

            const xScale_breed = d3.scaleBand()
                .domain(breedData.map(d => d.breed))
                .range([0, chartWidth_breed])
                .padding(0.4);

            const yScale_breed = d3.scaleLinear()
                .domain([0, 15])
                .range([chartHeight_breed / 2, 0]);

            const yScale_breed_neg = d3.scaleLinear()
                .domain([0, 15])
                .range([0, chartHeight_breed / 2]);

            // Add y-axis titles
            g_breed.append("text")
                .attr("y", 0)
                .attr("x", chartWidth_breed/2)
                .attr("text-anchor", "middle")
                .text("Bite Frequency Score")
                .style("font-size", "28px")
                .style("font-weight", "bold")
                .style("fill", "#041F3D");

            g_breed.append("text")
                .attr("y", 520)
                .attr("x", chartWidth_breed/2)
                .attr("text-anchor", "middle")
                .text("Owner-Rated Aggressiveness Score")
                .style("font-size", "28px")
                .style("font-weight", "bold")
                .style("fill", "#041F3D");

            // Create a group for each breed 
            const breedGroups = g_breed.selectAll(".breed-group")
                .data(breedData)
                .enter()
                .append("g")
                .attr("class", "breed-group")
                .attr("transform", d => `translate(${xScale_breed(d.breed)},0)`);

            // Add bars
            breedGroups.append("rect")
                .attr("class", "bar-bite")
                .attr("width", xScale_breed.bandwidth())
                .attr("y", d => yScale_breed(d.bite_score))
                .attr("height", d => chartHeight_breed / 2 - yScale_breed(d.bite_score))
                .attr("fill", "#ff8c42")
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("opacity", 0.8);

            breedGroups.append("rect")
                .attr("class", "bar-agg")
                .attr("width", xScale_breed.bandwidth())
                .attr("y", chartHeight_breed / 2)
                .attr("height", d => yScale_breed_neg(d.aggresiveness_score))
                .attr("fill", "#3ec9c1")
                .attr("rx", 3)
                .attr("ry", 3)
                .attr("opacity", 0.8);

            // Add image circles
            breedGroups.append("circle")
                .attr("class", "breed-image")
                .attr("cx", xScale_breed.bandwidth() / 2)
                .attr("cy", chartHeight_breed / 2)
                .attr("r", xScale_breed.bandwidth() * 0.75)
                .attr("fill", "white")
                .attr("stroke", "#041f3d")
                .attr("stroke-width", 2);

            // Add images
            breedGroups.append("image")
                .attr("class", "breed-img")
                .attr("xlink:href", d => `dog_cartoons/${d.breed.replaceAll(' ', '_')}.png`)
                .attr("x", -xScale_breed.bandwidth() * 0.2)
                .attr("y", chartHeight_breed/2 - xScale_breed.bandwidth() * 0.65)
                .attr("width", xScale_breed.bandwidth() * 1.4)
                .attr("height", xScale_breed.bandwidth() * 1.4);

            // Style tooltip
            const tooltip = g_breed.append("g")
                .attr("class", "tooltip")
                .style("opacity", 0)
                .style("pointer-events", "none");

            tooltip.append("rect")
                .attr("width", 480)
                .attr("height", 150)
                .attr("rx", 10)
                .attr("ry", 10)
                .attr("fill", "white")
                .attr("stroke", "#041F3D")
                .attr("stroke-width", 2);

            tooltip.append("image")
                .attr("class", "tooltip-img")
                .attr("x", 10)
                .attr("y", 20)
                .attr("width", 110)
                .attr("height", 110);

            tooltip.append("text")
                .attr("class", "tooltip-title")
                .attr("x", 130)
                .attr("y", 50)
                .style("font-size", "20px")
                .style("font-weight", "bold");

            tooltip.append("text")
                .attr("class", "tooltip-bite")
                .attr("x", 130)
                .attr("y", 80)
                .style("font-size", "18px");

            tooltip.append("text")
                .attr("class", "tooltip-agg")
                .attr("x", 130)
                .attr("y", 110)
                .style("font-size", "18px");

            // Hover-over functions
            breedGroups.on("mouseover", function(event, d) {

                d3.select(this).selectAll("rect")
                    .attr("opacity", 1)
                    .attr("stroke", "#041F3D")
                    .attr("stroke-width", 2);

                // Dim other breeds
                breedGroups.filter(dd => dd !== d).selectAll("rect")
                    .attr("opacity", 0.3);

                const [mouseX, mouseY] = d3.pointer(event, svg_breed.node());
    
                const tooltipWidth = 480;
                const tooltipHeight = 150;
                const padding = 10;
    
                let x;
                if (mouseX > width_breed - tooltipWidth - padding) {
                    x = mouseX - tooltipWidth - padding;
                } else {
                    x = mouseX + padding;
                }
    
                let y;
                if (mouseY < chartHeight_breed / 2) { 
                    y = mouseY + padding;
                } else {
                    y = mouseY - tooltipHeight - padding;
                }
    
                // Do boundary checks
                y = Math.max(padding, Math.min(y, height_breed - tooltipHeight - padding));

                tooltip.style("opacity", 1)
                    .attr("transform", `translate(${x},${y})`);

                tooltip.select(".tooltip-img")
                    .attr("xlink:href", `dog_cartoons/${d.breed.replaceAll(' ', '_')}.png`);

                tooltip.select(".tooltip-title")
                    .text(d.breed);

                tooltip.select(".tooltip-bite")
                    .text(`Bite Frequency: ${d.bite_score} (out of 15)`);

                tooltip.select(".tooltip-agg")
                    .text(`Owner-Rated Aggressiveness: ${d.aggresiveness_score} (out of 15)`);
            })
            .on("mousemove", function(event) {
                const [mouseX, mouseY] = d3.pointer(event, svg_breed.node());
    
                const tooltipWidth = 480;
                const tooltipHeight = 150;
                const padding = 10;
    
                let x;
                if (mouseX > width_breed - tooltipWidth - padding) {
                    x = mouseX - tooltipWidth - padding;
                } else {
                    x = mouseX + padding;
                }
    
                let y;
                if (mouseY < chartHeight_breed / 2) {
                    y = mouseY + padding;
                } else {
                    y = mouseY - tooltipHeight - padding;
                }
    
                // Move tooltip
                y = Math.max(padding, Math.min(y, height_breed - tooltipHeight - padding));

                tooltip.attr("transform", `translate(${x},${y})`);
            })
            .on("mouseout", function() {
                breedGroups.selectAll("rect")
                    .attr("opacity", 0.8)
                    .attr("stroke", "none");

                tooltip.style("opacity", 0);
            });

            // Create axes
            const yAxis_breed = d3.axisLeft(yScale_breed)
                .tickValues([0, 3, 6, 9, 12, 15])
                .tickSizeOuter(0);

            g_breed.append("g")
                .attr("class", "y-axis")
                .call(yAxis_breed)
                .call(g => g.select(".domain").attr("stroke", "#041F3D").attr("stroke-width", 2))
                .call(g => g.selectAll(".tick line").attr("stroke", "#041F3D").attr("stroke-width", 2))
                .call(g => g.selectAll(".tick text").style("font-size", "16px").style("fill", "#041F3D"));

            const yAxis_breed_neg = d3.axisLeft(yScale_breed_neg)
                .tickValues([0, 3, 6, 9, 12, 15])
                .tickSizeOuter(0);

            g_breed.append("g")
                .attr("transform", `translate(0,${chartHeight_breed / 2})`)
                .attr("class", "y-axis")
                .call(yAxis_breed_neg)
                .call(g => g.select(".domain").attr("stroke", "#041F3D").attr("stroke-width", 2))
                .call(g => g.selectAll(".tick line").attr("stroke", "#041F3D").attr("stroke-width", 2))
                .call(g => g.selectAll(".tick text").style("font-size", "16px").style("fill", "#041F3D"));


            // --------------------------------------------------
            // --------------------------------------------------
            // --------------------------------------------------


            // Bite incidents by time
            const timeData = await d3.csv("time_df.csv");

            const monthlyTotals = {};

            timeData.forEach(d => {
                const key = `${String(d.month).padStart(2, '0')}-${d.year}`;
                const bites = +d.number_of_bites;
                const temp = +d.temperature_avg;

                if (!monthlyTotals[key]) {
                    monthlyTotals[key] = {
                        monthYear: key,
                        year: +d.year,
                        month: +d.month,
                        totalBites: 0,
                        tempSum: 0,
                        dayCount: 0
                    };
                }
                monthlyTotals[key].totalBites += bites;
                monthlyTotals[key].tempSum += temp;
                monthlyTotals[key].dayCount += 1;
            });

            const monthlyData = Object.values(monthlyTotals).map(d => {
                return {
                    monthYear: d.monthYear,
                    year: d.year,
                    month: d.month,
                    totalBites: d.totalBites,
                    avgTemp: d.tempSum / d.dayCount
                };
            }).sort((a, b) => a.year - b.year || a.month - b.month);

            const svg_time = d3.select("#svg-time");
            const width_time = +svg_time.attr("width");
            const height_time = +svg_time.attr("height");
            const margin_time = { top: 10, right: 10, bottom: 50, left: 50 };
            const chartWidth_time = width_time - margin_time.left - margin_time.right;
            const chartHeight_time = height_time - margin_time.top - margin_time.bottom;

            const g_time = svg_time.append("g")
                .attr("transform", `translate(${margin_time.left},${margin_time.top})`);

            const xScale_time = d3.scaleLinear()
                .domain([0, monthlyData.length - 1])
                .range([0, chartWidth_time]);

            const yScale_time = d3.scaleLinear()
                .domain(d3.extent(monthlyData, d => d.totalBites))
                .range([chartHeight_time, 0]);

            const time_bite_line = d3.line()
                .x((d, i) => xScale_time(i))
                .y(d => yScale_time(d.totalBites));

            g_time.append("path")
                .datum(monthlyData)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", time_bite_line);


            // const xAxis_time = d3.axisBottom(xScale_time)
            //     .ticks(monthlyData.length)
            //     .tickFormat((d, i) => monthlyData[i].monthYear);


            const xAxis_time = d3.axisBottom(xScale_time)
                .ticks(monthlyData.length)
                .tickFormat((d, i) => {
                    if (i % 12 === 0) {
                        return monthlyData[i].monthYear;
                    }
                    return '';
                });

            g_time.append("g")
                .attr("transform", `translate(0,${chartHeight_time})`)
                .call(xAxis_time)
                .selectAll("text")
                .attr("transform", "rotate(45)")
                .style("text-anchor", "start");

            // Y-axis
            const yAxis_time = d3.axisLeft(yScale_time);
            g_time.append("g").call(yAxis_time);
        }

        requestData();
    </script>


</body>